---
title: "Housing Data Afer the 2007 Market Crash"
author: "Austin Huber"
date: "Due December 17, 2019"
output:  html_notebook
---

```{r include=FALSE}
# clean up workspace environment
rm(list = ls())
```

All packages used for the assignment can be found below:
```{r}
library(ggplot2)
library(DataComputing)
library(tidyr)
library(tidyverse)
library(dplyr)
library(lubridate)
library(readr)
```


## Research Question

**How long did the recovery of the housing market take in the US after the 2007-08 market crash? How have prices changed since then? Does location have any impact on the recovery of housing prices?**


## Data Access

Loading the data as a whole into a new variable in the RStudio environment. Here is the link of where the data was acquired from: https://www.zillow.com/research/data/
```{r include=FALSE}
Saleprices <- read_csv("Sale_Prices_Msa.csv")
DaysUp <- read_csv("DaysOnZillow_State.csv")
SalePricesState <- read_csv("Sale_Prices_State.csv")
```
### House pricing dataset with 626 US Cities (2008-2019, monthly)
```{r echo=FALSE}
cat("Number of rows: ",nrow(Saleprices),"\nNumber of columns: ",ncol(Saleprices),"\n")
```
```{r}
head(Saleprices)
```
### House pricing dataset with 50 US States (2008-2019, monthly)
```{r echo=FALSE}
cat("Number of rows: ",nrow(SalePricesState),"\nNumber of columns: ",ncol(SalePricesState),"\n")
```
```{r}
head(SalePricesState)
```
### Number of days a listing spent on Zillow per US State dataset (2010-2019, monthly)
```{r echo=FALSE}
cat("Number of rows: ",nrow(DaysUp),"\nNumber of columns: ",ncol(DaysUp),"\n")
```
```{r}
head(DaysUp)
```

## Wrangling

I decided to create 4 different data sets, with 3 of them being used for graphics. These 3 include: US mean, max, and min prices for every month, the US mean, max, and min prices per state for every month, and the US mean, max, and min prices per top 626 cities for every month.
```{r}
# Isolates just the months and their data by removing first 3 columns
JustMonths <- Saleprices[-c(1,2,3)]
JustMonthsState <- SalePricesState[-c(1,2,3)]

# Creates the applyFunction to be used by 3 different data frames
applyFun <- function(set,num,fun){
  return(apply(set,num,fun,na.rm=TRUE))
}

# Creates a dataset of minimum, maximum, and mean values for each month, from the city data
MonthlyCalcs <- data.frame("month"=colnames(JustMonths),"Min"=applyFun(JustMonths,2,min),"Max"=applyFun(JustMonths,2,max),"Mean"=applyFun(JustMonths,2,mean))
head(MonthlyCalcs)

# This is the average data for all of the United States in a narrow format
USdata <- Saleprices %>% filter(RegionID==102001) %>% gather(month, price, -RegionID, -RegionName, -SizeRank)
USExtensiveData <- USdata %>% left_join(MonthlyCalcs, by=c("month"="month"))
head(USExtensiveData)

# This data set contains the minimum, maximum, and mean values for each state over all the months
MinMaxMeanPerState <- 
  SalePricesState %>%
  mutate(MinimumPrice = applyFun(JustMonthsState,1,min)) %>%
  mutate(MaximumPrice = applyFun(JustMonthsState,1,max)) %>%
  mutate(MeanPrice = applyFun(JustMonthsState,1,mean)) %>%
  mutate(Difference = MaximumPrice-MinimumPrice)
head(MinMaxMeanPerState)

# This data set contains the minimum, maximum, and mean values for each city over all the months
MinMaxMeanPerCity <- 
  Saleprices %>%
  mutate(MinimumPrice = applyFun(JustMonths,1,min)) %>%
  mutate(MaximumPrice = applyFun(JustMonths,1,max)) %>%
  mutate(MeanPrice = applyFun(JustMonths,1,mean))
head(MinMaxMeanPerCity)
```

## Visualizations

This graphic below shows 2 different lines, one line shows the average house prices of all houses in the entire US, the other shows the average house price of the top 626 cities in the US. What this graphic helps to show is how hard the market crash impacted Americans. Both rates decrease at the same rate, but the average for the US increases much more quickly than the average for the cities does. After millions losing their jobs and many more their savings in the market, they could no longer afford to live in cities and spend a ton of money on housing. These people were driven to find housing in more rural areas which is shown by the gap between the red and blue. During this time the distrust for the American government grew. People were afraid to put money down on expensive houses near the cities, so they took the safer bet and moved more rural.

```{r}
USExtensiveData %>%
  mutate(month = lubridate::dym(month)) %>%
  filter(month!="2019-10-20") %>%
  ggplot(aes(x=month,y=Mean,color="Average in top 626 Cities"))+geom_line(size=1)+geom_line(mapping=aes(y=price,color="Average in all of the US"),size=1)+ggtitle("Average Price of Houses in the US")+xlab("Years")+ylab("Price (in dollars)")
```

This graphic shows that there were more people moving out West after the housing crisis. The variable "Difference" is the difference between the cheapest house price of that state and the most expensive. As more people wanted to move out West, the demand for housing increased which increased the prices of homes more quickly. These people moving is what caused such a big difference in price. Whereas on the East coast and North-East there was not much change in price since people were not moving there.
```{r}
USMap(data=MinMaxMeanPerState, key="RegionName", fill=Difference)
```

And finally this graphic is one that helps to show the density of mean prices. Again in the red we have the mean values of all the US states and in blue we have the mean value of the top 626 cities in the US. The mean prices of the cities increase faster than the states but then also drop off much faster. Whereas the mean prices of the states takes longer to increase but also remains at that point longer. This graphic is interesting because it shows that there are more, higher prices for houses throughout all the states when compared to the cities. The houses in cities lost their value whereas the houses in more remote areas held their value or even increased.
```{r}
ggplot( data = MinMaxMeanPerState, aes(x = MeanPrice,fill="All US States")) + geom_density(adjust = 0.38,alpha=.5)+labs(title = "")+geom_density(aes(x = MeanPrice,fill="Top 626 Cities"),MinMaxMeanPerCity,adjust = 0.38,alpha=.5)+guides(fill=guide_legend(title="Data"))
```

for (i in 1:nrow(TopBot)) {
  first <- TopBot[i,4]
  for (j in 4:nccol(TopBot)) {
    if (TopBot[i,j]>first) {
      TopBot <- TopBot[i,149] + colnames(TopBot)[j]
      break
    }
  }
}

```{r}
# find the time between the start and when it hits that price again

top <- MinMaxMeanPerState %>% filter(SizeRank!=3) %>% head(10) %>% mutate(Size="Top")
bot <- MinMaxMeanPerState %>% filter(SizeRank!=41, SizeRank!=42, SizeRank!=43) %>% tail(10) %>% mutate(Size="Bottom")
TopBot <- rbind(top,bot)
TopBot
TopBot$Second <- c("")
TopBot
FirstSecMonth <- TopBot %>% select(RegionName,Size,First="2008-03",Second)
FirstSecMonth$Second <- c("")

new <- FirstSecMonth[,3] + 5
new




#mutate(first = lubridate::dym(first)) %>% mutate(second = lubridate::dym(second)) %>% mutate(DiffDays=second-first) %>% select(RegionName,Size,DiffDays)



```




